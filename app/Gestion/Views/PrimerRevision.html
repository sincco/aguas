{% include 'header.html' %}
{% include 'menu.html' %}

<div class="container">
	<div class="row">
		<h1>Primer revisión</h1>
		<div class="row">
			<div class="col-lg-6">
				<div class="input-group">
					<input type="text" name="contrato" class="form-control" placeholder="Contrato...">
					<span class="input-group-btn">
						<button class="btn btn-primary" type="button" onclick="buscarContrato();">Buscar</button>
					</span>
				</div>
			</div>
		</div>
	</div>

	<div class="row rowContrato">
		<div class="row">
			<div class="col-xs-4"><h4>Estatus: <span data-field="status"></span></h4></div>
			<div class="col-xs-4"><h4>Observaciones: <span data-field="anexo"></span></h4></div>
			<div class="col-xs-4"><h4>Fecha: <span data-field="fechaEstatus"></span></h4></div>
		</div>

		<div class="row">
			<h4>Datos del contrato</h4>
		</div>
		
		<div class="row">
			<div class="col-lg-6">
				<label>Propiertario: <span data-field="propietario"></span></label>
			</div>
			<div class="col-lg-6">
				<label>Usuario: <span data-field="usuario"></span></label>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-3">
				<label>Suministro: <span data-field="suministro"></span></label>
			</div>
			<div class="col-lg-3">
				<label>numTomas: <span data-field="numTomas"></span></label>
			</div>
			<div class="col-lg-3">
				<label>Giro: <span data-field="giro"></span></label>
			</div>
			<div class="col-lg-3">
				<label>GPS: <span data-field="gps"></span></label>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				<label>Direccion: <span data-field="direccion"></span></label>
			</div>
		</div>
		<div class="row">
			<h4>Medidor Retirado</h4>
			<div class="col-lg-4">
				<label>Marca: <span data-field="marca_act"></span></label>
			</div>
		</div>
		<div class="row">
			<h4>Medidor Instalado</h4>
			<div class="col-lg-4">
				<label>N/S: <span data-field="serieMedidor"></span></label>
			</div>
			<div class="col-lg-4">
				<label>Telemetría: <span data-field="telemetriaMedidor"></span></label>
			</div>
		</div>
	</div>

	<div class="row rowImagenes"></div>

	<div class="row rowProceso">
		<h4>Evaluar captura</h4>
		<div class="col-xs-6"><label>Observaciones :</label><textarea name="observaciones" class="form-control"></textarea></div>
		<div class="col-xs-6">
			<div class="row">
				<div class="col-xs-6"><button class="btn btn-success" type="button" onclick="cambiarEstatus(7,$('[name=observaciones]').val());">Aprobado</button></div>
				<div class="col-xs-6"><button class="btn btn-danger" type="button" onclick="cambiarEstatus(8,$('[name=observaciones]').val());">No aprobado</button></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
$(function() {
	$("[name=contrato]").keypress(function(event) {
		if(event.which == 13) buscarContrato();
	});

	$('.rowImagenes').hide();
	$('.rowContrato').hide();
	$('.rowImagenes').hide();
	$('.rowProceso').hide();
});

function buscarContrato() {
	loader.show();
	$('.rowImagenes').hide();
	$('.rowContrato').hide();
	$('.rowProceso').hide();
	$('[data-field=propietario]').html('');
	$('[data-field=usuario]').html('');
	$('[data-field=suministro]').html('');
	$('[data-field=numTomas]').html('');
	$('[data-field=direccion]').html('');
	$('[data-field=gps]').html('');
	$('[data-field=giro]').html('');
	$('[data-field=marca_act]').html('');
	$('[data-field=serieMedidor]').html('');
	$('[data-field=telemetriaMedidor]').html('');
	$('[data-field=status]').html('');
	$('[data-field=fechaEstatus]').html('');
	$('[data-field=anexo]').html('');
	$('[name=observaciones]').val('');
	sincco.consumirAPI('GET', BASE_URL + 'api/v2/expedientes/resumen?filters[contrato]=' + $('[name=contrato]').val())
	.done(function(data) {
		if (data.data.length) {
			$('.rowImagenes').show();
			$('.rowContrato').show();

			$(data.data).each(function(){
				$('[data-field=propietario]').html(this.propietario);
				$('[data-field=usuario]').html(this.usuario);
				$('[data-field=suministro]').html(this.suministro);
				$('[data-field=numTomas]').html(this.numTomas);
				$('[data-field=direccion]').html(this.via + ' ' + this.calle + ' ' + this.numOficial + ', ' + this.colonia + ' ' + this.municipio);
				$('[data-field=giro]').html(this.giro);
				$('[data-field=marca_act]').html(this.marca_act);
				$('[data-field=gps]').html(this.longitud + ' , ' + this.latitud);
				$('[data-field=serieMedidor]').html(this.serieMedidor);
				$('[data-field=telemetriaMedidor]').html(this.telemetriaMedidor);
				$('[data-field=status]').html(this.status);
				$('[data-field=fechaEstatus]').html(this.fechaEstatus);
				$('[data-field=anexo]').html(this.anexo);
				sincco.consumirAPI('POST', BASE_URL + 'api/v2/expedientes/imagenes', {contrato:$('[name=contrato]').val()})
				.done(function(data) {
					$('.rowImagenes').html('');
					$(data.data).each(function(){
						var prev = $('.rowImagenes').html();
						prev += '<div class="row"><div class="col-xs-10"><img width="100%" src="' + this.base64 + '"></div></div>';
						$('.rowImagenes').html(prev);
					});
				});
				if (this.statusId != 5) {
					toastr.error('El contrato no está terminado.', 'Intenta de nuevo');
				} else {
					$('.rowProceso').show();
				}
			})
		} else {
			toastr.error('El contrato no existe.', 'Intenta de nuevo');
		}
		loader.hide();
	}).fail(function(jqXHR, textStatus, errorThrown) {
		toastr.error('Error al hacer la petición del código.', 'Intenta de nuevo');2439812
		loader.hide();
	});
}

function cambiarEstatus(estatus, motivo) {
	sincco.consumirAPI('POST', BASE_URL + 'expedientes/index/apisetestatus', {contrato:$('[name=contrato]').val(), estatus: estatus, motivo: motivo})
	.done(function(data) {
		if (data.respuesta) {
			$('.rowImagenes').hide();
			$('.rowContrato').hide();
			$('.rowProceso').hide();
			$('[data-field=propietario]').html('');
			$('[data-field=usuario]').html('');
			$('[data-field=suministro]').html('');
			$('[data-field=numTomas]').html('');
			$('[data-field=direccion]').html('');
			$('[data-field=gps]').html('');
			$('[data-field=giro]').html('');
			$('[data-field=marca_act]').html('');
			$('[data-field=serieMedidor]').html('');
			$('[data-field=telemetriaMedidor]').html('');
			$('[data-field=status]').html('');
			$('[data-field=fechaEstatus]').html('');
			$('[data-field=anexo]').html('');
			toastr.success('Estatus actualizado.', 'Hecho');
		}
	}).fail(function(jqXHR, textStatus, errorThrown) {
		toastr.error('Error al hacer la petición del código.', 'Intenta de nuevo');
		loader.hide();
	});
}
</script>

